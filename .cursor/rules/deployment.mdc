---
description: Deployment skill - complete workflow for committing, versioning, building, and deploying to Xcode, staging, and production
globs:
  - deploy-manualmode.sh
  - scripts/deploy-production-scheduled.sh
  - podman-compose-staging.yml
  - podman-compose-production.yml
  - Dockerfile
  - meaningful-conversations-backend/Dockerfile
  - meaningful-conversations-backend/tts-service/Dockerfile
  - .env.staging
  - .env.production
  - BUILD_NUMBER
alwaysApply: false
---

# Deployment Skill

Use this skill whenever the user requests a commit, version bump, Xcode build, or deployment to staging/production. It captures the full operational knowledge so you don't have to rediscover it each time.

## Version Source of Truth

The **canonical version** lives in `package.json` (frontend root). The deploy script reads it from there automatically:
```
VERSION=$(grep -m1 '"version"' package.json | awk -F'"' '{print $4}')
```

**Do NOT** add VERSION to `.env` files ‚Äî it will be ignored by the deploy script.

### Files That Must Be Updated on Version Bump

When the user requests a new version (e.g. "commit as version 1.8.7"), update ALL of these:

| File | What to change |
|---|---|
| `package.json` | `"version": "X.Y.Z"` |
| `meaningful-conversations-backend/package.json` | `"version": "X.Y.Z"` |
| `components/AboutView.tsx` | `{t('about_version')} X.Y.Z` |
| `metadata.json` | `"name": "Meaningful Conversations X.Y.Z"` |
| `public/sw.js` | `CACHE_NAME = 'meaningful-conversations-cache-vX.Y.Z-bN'` |

The `BUILD_NUMBER` file is incremented for Xcode builds within the same version; reset to `1` when the version number changes.

### Version Rules
- **ALWAYS ask the user** for the version number if not specified
- **NEVER** automatically increment or change version numbers without explicit user request
- **NEVER** decrement version numbers
- Format: MAJOR.MINOR.PATCH (e.g., 1.8.6)
- **IMPORTANT:** When user requests "commit" or "deploy" WITHOUT mentioning a version change, do NOT update version numbers in any files

## Deployment Targets

### 1. Xcode (iOS Build)

```bash
npm run build
npx cap sync ios
```

- This copies web assets from `dist/` to `ios/App/App/public/` and syncs Capacitor plugins
- After sync, the user opens `ios/App/App.xcworkspace` in Xcode and builds from there
- Increment `BUILD_NUMBER` if deploying a new Xcode build for the same version
- If the Capacitor plugin list changed, Xcode may need to resolve Swift packages

### 2. Staging

```bash
./deploy-manualmode.sh -e staging
```

- Builds all 3 Docker images (backend, frontend, TTS)
- Pushes to registry `quay.myandi.de/gherold`
- Pulls on remote server, stops old containers, starts new ones
- Updates nginx reverse proxy IPs
- Runs health checks; **auto-rollback on failure**
- URL: https://mc-beta.manualmode.at

### 3. Production

```bash
./deploy-manualmode.sh -e production
```

- Automatically skips build & push ‚Äî pulls pre-built staging images from registry
- Principle: **"Build once, deploy everywhere"** ‚Äî production runs the exact same images tested on staging
- Same deployment flow as staging (pull, stop, start, nginx update, health checks, auto-rollback)
- **NEVER deploy to production without explicit user approval**
- **ALWAYS deploy to staging first** and verify
- URL: https://mc-app.manualmode.at

### 4. Production (Scheduled / No-Build)

```bash
./scripts/deploy-production-scheduled.sh [VERSION]
```

- Standalone script for automated/scheduled production deployments (e.g. via cron)
- Same principle as above: pulls pre-built images, no rebuild
- Includes additional safety checks: database integrity (user count before/after)
- Can be used independently without the main deploy script

## Complete Deployment Checklist

### Step 1: Version Bump (ONLY if user explicitly requests a version change)

**‚ö†Ô∏è CRITICAL:** Only perform version bump if user explicitly says "version X.Y.Z" or "bump version" or similar!

If user only says "commit" or "deploy" WITHOUT mentioning version, SKIP this step entirely!

When the user explicitly requests a version change (e.g., "commit as vX.Y.Z"):
- [ ] Update all 5 version files (see table above)
- [ ] Reset `BUILD_NUMBER` to `1` if version changed

### Step 2: Database Migrations

**üö® CRITICAL: STOP! Check for schema changes BEFORE any deployment!**

**‚ö†Ô∏è IMPORTANT: Always test migrations in local dev FIRST!**

See **[DOCUMENTATION/LOCAL-DEV-MIGRATIONS.md](../DOCUMENTATION/LOCAL-DEV-MIGRATIONS.md)** for:
- Local migration workflow and troubleshooting
- Shadow database error solutions
- Migration history resolution
- Manual migration creation when needed

**MANDATORY Pre-Deployment Check:**
- [ ] Run `git diff main -- meaningful-conversations-backend/prisma/schema.prisma` to check for schema changes
- [ ] If schema.prisma changed OR new migrations exist in `prisma/migrations/`, migrations are required
- [ ] **NEVER deploy without testing migrations locally first!**

**Local Dev Migration (REQUIRED if schema changed):**
- [ ] Check if Prisma schema changed: `meaningful-conversations-backend/prisma/schema.prisma`
- [ ] If changed: generate migration with `cd meaningful-conversations-backend && npx prisma migrate dev --name descriptive-name`
- [ ] **CRITICAL:** Check migration SQL file for correct table name casing (e.g., `User` not `user`)
- [ ] Verify: `npx prisma migrate status` should show "Database schema is up to date!"
- [ ] Test locally: start dev servers and verify feature works
- [ ] **VERIFY:** Test creating records that use the new schema

**Remote Migrations (after local testing, BEFORE deployment):**

**üî¥ DO NOT run `./deploy-manualmode.sh` until migrations are verified on target!**

Order of operations:
1. Deploy migration files to staging (via git pull or manual copy)
2. Manually run migration on staging FIRST:
   ```bash
   ssh root@91.99.193.87 'podman exec meaningful-conversations-backend-staging npx prisma migrate deploy'
   ```
3. Verify migration succeeded (check logs, no errors)
4. THEN deploy application code: `./deploy-manualmode.sh -e staging`

**‚ö†Ô∏è Why this order matters:**
- Backend startup automatically runs migrations
- If migration fails ‚Üí backend won't start ‚Üí 502 errors
- Testing migration separately allows fixing issues before deployment
- Rollback is easier if only migration failed (not full deployment)

**Common Migration Issues:**
- ‚ùå Wrong table name casing (`user` vs `User`) - MySQL on macOS is case-insensitive, Linux is case-sensitive!
- ‚ùå Foreign key references to non-existent tables
- ‚ùå Duplicate migrations in history table
- ‚ùå Shadow database errors (see LOCAL-DEV-MIGRATIONS.md)

### Step 3: Commit & Push
- [ ] `git add` all changed files
- [ ] Commit with descriptive message referencing version
- [ ] `git push`

### Step 4: Build & Sync for Xcode
- [ ] `npm run build`
- [ ] `npx cap sync ios`
- [ ] Verify: "Sync finished" in output

### Step 5: Deploy to Staging
- [ ] `./deploy-manualmode.sh -e staging`
- [ ] Wait for "Deployment Complete" and health check success
- [ ] If health check fails: auto-rollback kicks in ‚Äî check logs

### Step 6: Deploy to Production (only if requested)
- [ ] Confirm user explicitly approved
- [ ] `./deploy-manualmode.sh -e production` (auto-skips build, pulls staging images)
- [ ] Wait for "Deployment Complete" and health check success
- [ ] If health check fails: auto-rollback kicks in ‚Äî check logs

## Deploy Script Options

```
./deploy-manualmode.sh [OPTIONS]

Options:
  -e, --env ENV         staging (default) or production
  -c, --component COMP  all (default), frontend, backend, or tts
  --server HOST         Remote server override
  -s, --skip-build      Skip building images (use existing)
  -p, --skip-push       Skip pushing to registry
  -d, --dry-run         Show what would happen
  -v, --version VER     Override version (default: from package.json)
```

## Server & Infrastructure

| Item | Value |
|---|---|
| Remote server | `root@91.99.193.87` |
| Staging dir | `/opt/manualmode-staging` |
| Production dir | `/opt/manualmode-production` |
| Registry | `quay.myandi.de/gherold` |
| Container runtime | Podman + podman-compose |
| Reverse proxy | Nginx (on same server) |

### Useful Remote Commands

```bash
# Staging logs
ssh root@91.99.193.87 'cd /opt/manualmode-staging && podman-compose -f podman-compose-staging.yml logs -f'

# Staging status
ssh root@91.99.193.87 'cd /opt/manualmode-staging && podman-compose -f podman-compose-staging.yml ps'

# Staging restart
ssh root@91.99.193.87 'cd /opt/manualmode-staging && podman-compose -f podman-compose-staging.yml restart'

# Single container logs (e.g. backend)
ssh root@91.99.193.87 'podman logs --tail 100 meaningful-conversations-backend-staging'

# Production
ssh root@91.99.193.87 'cd /opt/manualmode-production && podman-compose -f podman-compose-production.yml logs -f'
```

### Run Prisma Migration Remotely

```bash
# Staging
ssh root@91.99.193.87 'podman exec meaningful-conversations-backend-staging npx prisma migrate deploy'

# Production
ssh root@91.99.193.87 'podman exec meaningful-conversations-backend-production npx prisma migrate deploy'
```

## Automatic Rollback

The deploy script handles rollback automatically:
1. Before deploying, saves current version to `.previous-version` on the server
2. After deploying, runs health checks (3 retries, 10s interval)
3. If health checks fail:
   - Stops failed containers
   - Pulls previous version images from registry
   - Restarts with previous version
   - Updates nginx
   - Verifies rollback health
4. If rollback also fails: manual intervention required ‚Äî SSH in and check logs

## Known Pitfalls & Lessons Learned

### v1.8.4: `npm install` vs `npm ci` in Docker
**Problem:** `express-rate-limit ^8.2.1` resolved to a newer 8.x with a breaking validation change (`ERR_ERL_KEY_GEN_IPV6`), crashing the staging backend.
**Fix:** Always use `npm ci` in Dockerfiles. After adding/updating dependencies locally, commit the updated `package-lock.json` before deploying.

### v1.8.4: 502 After Staging Deploy (Missing DB Migration)
**Problem:** New code expected a database column that didn't exist yet ‚Äî backend crashed with 502.
**Fix:** Always run DB migrations BEFORE or immediately after deploying new code. Check if `schema.prisma` changed in the diff. See [LOCAL-DEV-MIGRATIONS.md](../DOCUMENTATION/LOCAL-DEV-MIGRATIONS.md) for local testing workflow.

### v1.8.7: Shadow Database Errors in Local Dev
**Problem:** `prisma migrate dev` fails with "Migration failed to apply cleanly to the shadow database" when migration history is out of sync.
**Fix:** Use `prisma db push` to sync schema, then mark existing migrations as applied with `prisma migrate resolve --applied`. See [LOCAL-DEV-MIGRATIONS.md](../DOCUMENTATION/LOCAL-DEV-MIGRATIONS.md) for detailed troubleshooting steps.

### v1.8.x: Missing `await` on Async Function (Silent Production Failure)
**Problem:** `profile = decryptPersonalityProfile(...)` was missing `await` in `App.tsx`. The function returned a Promise object instead of the decrypted profile. In Production, the personality profile was silently ignored during Transcript Evaluation because the profile variable was a truthy Promise (not `null`), but not actual profile data. Staging worked because of a different code path.
**Fix:** Added `await` before `decryptPersonalityProfile()`. **Lesson:** Always `await` async functions, especially when the return value is passed to other functions. A Promise object is truthy but useless as data ‚Äî this kind of bug is invisible without runtime evidence.

### v1.8.x: Transcript Evaluation DB Migration
**Problem:** New `userRating`, `userFeedback`, `ratedAt` fields added to `TranscriptEvaluation` model. Migration created manually because `prisma migrate dev` had shadow database issues.
**Fix:** Created manual SQL migration file `20260214120000_add_evaluation_rating/migration.sql`. **Lesson:** When `prisma migrate dev` fails, create migrations manually ‚Äî see LOCAL-DEV-MIGRATIONS.md.

### v1.8.5: Version Sync Forgotten
**Problem:** Version was bumped in `package.json` but not in `AboutView.tsx` or `sw.js`, causing user confusion about which version was deployed.
**Fix:** Always update ALL 5 version files (see table above).

### Service Worker Cache
`public/sw.js` contains a `CACHE_NAME` with the version. If not updated, browsers may serve stale assets after deployment. The `-bN` suffix (build number) can be incremented for cache-busting within the same version.

### iOS Capacitor: Stale Assets
After `npm run build`, always run `npx cap sync ios`. Without this, Xcode bundles old web assets into the iOS app.

### Docker Build Cache
TTS image rarely changes and is heavily cached (most steps say "Using cache"). Backend and frontend images rebuild the `COPY . .` step on every deploy. This is expected.

## Dependency Management
- **ALWAYS** `npm ci` in Dockerfiles for reproducible builds
- **NEVER** `npm install` in production/staging Docker builds
- After local `npm install`, commit `package-lock.json`
- Semver ranges in `package.json` are fine for local dev; lockfile ensures prod consistency

## Environment URLs
- **Local Dev**: http://localhost:5173 (frontend), http://localhost:3001 (backend)
- **Staging**: https://mc-beta.manualmode.at
- **Production**: https://mc-app.manualmode.at
