# This configuration file is designed to correctly serve a Single Page Application (SPA)
# like the one built by Vite/React, fixing the common "Unexpected token '<'" error.

server {
    # Nginx listens on port 80 inside the container. Google Cloud Run will forward
    # traffic from its external port (443 for HTTPS) to this port.
    listen 80;

    # The root directory where your static files (from the 'dist' folder) are located.
    # This path must match the COPY destination in your frontend Dockerfile.
    root /usr/share/nginx/html;

    # The default file to serve.
    index index.html;

    # Ensure correct MIME types for PWA files (critical for iOS)
    types {
        application/manifest+json  json;
        application/javascript     js;
        text/css                   css;
        image/png                  png;
        image/jpeg                 jpg jpeg;
        image/svg+xml              svg;
        image/x-icon               ico;
        text/html                  html;
    }

    # Serve manifest.json with correct MIME type and force reload
    location = /manifest.json {
        types { }
        default_type application/manifest+json;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
    }

    # Serve service worker with correct headers
    location = /sw.js {
        types { }
        default_type application/javascript;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
    }
    
    # Force reload of index.html (no caching)
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }
    
    # Apple touch icons should not be cached during testing
    location ~* ^/apple-touch-icon.*\.png$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        try_files $uri =404;
    }

    # This is the most critical block for an SPA.
    location / {
        # 'try_files' tells Nginx how to handle requests:
        # 1. $uri: First, try to find a file that exactly matches the request.
        #    (e.g., /assets/index-abcdef.js)
        # 2. $uri/: If not found, try to find a directory with that name.
        # 3. /index.html: If both fail, serve the index.html file.
        #    This allows your client-side router to handle the URL without the server
        #    returning a 404 error, which is what causes the syntax error.
        try_files $uri $uri/ /index.html;
    }

    # Optional but recommended: Add aggressive caching headers for your static assets.
    # Since Vite includes hashes in filenames, we can cache them for a very long time.
    location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}