generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String        @id @default(cuid())
  email                     String        @unique
  firstName                 String?
  lastName                  String?
  newsletterConsent         Boolean       @default(false)
  newsletterConsentDate     DateTime?
  passwordHash              String
  encryptionSalt            String        @unique
  lifeContext               String?       @db.Text
  gamificationState         String?       @db.Text
  unlockedCoaches           String?       @db.Text
  isBetaTester              Boolean       @default(false)
  isAdmin                   Boolean       @default(false)
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  loginCount                Int           @default(0)
  lastLogin                 DateTime?
  status                    String        @default("PENDING")
  activationToken           String?       @unique
  activationTokenExpires    DateTime?
  passwordResetToken        String?       @unique
  passwordResetTokenExpires DateTime?
  accessExpiresAt           DateTime?
  feedbacksByUser           Feedback[]    @relation("UserToFeedbacks")
  upgradeCodesUsedByUser    UpgradeCode[] @relation("UserToUpgradeCodes")
}

model UpgradeCode {
  id         String   @id @default(cuid())
  code       String   @unique
  botId      String
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())
  usedById   String?
  usedByUser User?    @relation("UserToUpgradeCodes", fields: [usedById], references: [id])

  @@index([usedById])
}

model Ticket {
  id        String   @id @default(cuid())
  type      String
  status    String   @default("OPEN")
  payload   Json
  createdAt DateTime @default(now())
}

model Feedback {
  id              String   @id @default(cuid())
  rating          Int?
  comments        String   @db.Text
  botId           String
  lastUserMessage String?  @db.Text
  botResponse     String?  @db.Text
  isAnonymous     Boolean  @default(false)
  createdAt       DateTime @default(now())
  userId          String?
  feedbackByUser  User?    @relation("UserToFeedbacks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ApiUsage {
  id               String   @id @default(cuid())
  userId           String?
  isGuest          Boolean  @default(true)
  endpoint         String
  model            String
  botId            String?
  inputTokens      Int      @default(0)
  outputTokens     Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCostUSD Decimal  @default(0.000000) @db.Decimal(10, 6)
  durationMs       Int?
  success          Boolean  @default(true)
  errorMessage     String?  @db.Text
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([endpoint])
}

model GuestUsage {
  id           String   @id @default(cuid())
  fingerprint  String   @unique
  messageCount Int      @default(0)
  weekStart    DateTime
  lastUsed     DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([fingerprint])
  @@index([weekStart])
}
