// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String      @id @default(cuid())
  email                     String      @unique
  firstName                 String?
  lastName                  String?
  passwordHash              String
  encryptionSalt            String      @unique
  lifeContext               String?     @db.Text
  gamificationState         String?     @db.Text
  unlockedCoaches           String?     @db.Text
  isBetaTester              Boolean     @default(false)
  isAdmin                   Boolean     @default(false)
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  loginCount                Int         @default(0)
  lastLogin                 DateTime?
  status                    String      @default("PENDING")
  activationToken           String?     @unique
  activationTokenExpires    DateTime?
  passwordResetToken        String?     @unique
  passwordResetTokenExpires DateTime?
  accessExpiresAt           DateTime?

  // Explicitly named relations to other models
  upgradeCodesUsedByUser    UpgradeCode[] @relation("UserToUpgradeCodes")
  feedbacksByUser           Feedback[]    @relation("UserToFeedbacks")
}

model UpgradeCode {
  id         String   @id @default(cuid())
  code       String   @unique
  botId      String
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  // This field holds the foreign key
  usedById   String?
  
  // This defines the explicitly named relation to the User model
  usedByUser User?    @relation("UserToUpgradeCodes", fields: [usedById], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([usedById])
}

model Ticket {
  id        String   @id @default(cuid())
  type      String
  status    String   @default("OPEN")
  payload   Json
  createdAt DateTime @default(now())
}

model Feedback {
  id              String   @id @default(cuid())
  rating          Int?
  comments        String   @db.Text
  botId           String
  lastUserMessage String?  @db.Text
  botResponse     String?  @db.Text
  isAnonymous     Boolean  @default(false)
  createdAt       DateTime @default(now())

  // This field holds the foreign key
  userId          String?
  
  // This defines the explicitly named relation to the User model
  feedbackByUser  User?    @relation("UserToFeedbacks", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
}

model ApiUsage {
  id              String   @id @default(cuid())
  userId          String?
  isGuest         Boolean  @default(true)
  endpoint        String   // e.g., 'chat', 'analyze', 'format-interview'
  model           String   // e.g., 'gemini-2.5-flash', 'gemini-2.5-pro'
  botId           String?
  inputTokens     Int      @default(0)
  outputTokens    Int      @default(0)
  totalTokens     Int      @default(0)
  estimatedCostUSD Decimal @default(0) @db.Decimal(10, 6)
  durationMs      Int?
  success         Boolean  @default(true)
  errorMessage    String?  @db.Text
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([endpoint])
}