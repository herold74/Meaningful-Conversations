generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String        @id @default(cuid())
  email                     String        @unique
  firstName                 String?
  lastName                  String?
  preferredLanguage         String        @default("de")
  newsletterConsent         Boolean       @default(false)
  newsletterConsentDate     DateTime?
  unsubscribeToken          String?       @unique
  passwordHash              String
  encryptionSalt            String        @unique
  lifeContext               String?       @db.Text
  gamificationState         String?       @db.Text
  unlockedCoaches           String?       @db.Text
  isBetaTester              Boolean       @default(false)
  isAdmin                   Boolean       @default(false)
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  loginCount                Int           @default(0)
  lastLogin                 DateTime?
  status                    String        @default("PENDING")
  activationToken           String?       @unique
  activationTokenExpires    DateTime?
  passwordResetToken        String?       @unique
  passwordResetTokenExpires DateTime?
  accessExpiresAt           DateTime?
  feedbacksByUser           Feedback[]    @relation("UserToFeedbacks")
  upgradeCodesUsedByUser    UpgradeCode[] @relation("UserToUpgradeCodes")
  personalityProfile        PersonalityProfile?
  sessionBehaviorLogs       SessionBehaviorLog[]
}

model UpgradeCode {
  id         String     @id @default(cuid())
  code       String     @unique
  botId      String
  isUsed     Boolean    @default(false)
  createdAt  DateTime   @default(now())
  usedById   String?
  usedByUser User?      @relation("UserToUpgradeCodes", fields: [usedById], references: [id])
  purchases  Purchase[]

  @@index([usedById])
}

model Ticket {
  id        String   @id @default(cuid())
  type      String
  status    String   @default("OPEN")
  payload   Json
  createdAt DateTime @default(now())
}

model Feedback {
  id              String   @id @default(cuid())
  rating          Int?
  comments        String   @db.Text
  botId           String
  lastUserMessage String?  @db.Text
  botResponse     String?  @db.Text
  isAnonymous     Boolean  @default(false)
  createdAt       DateTime @default(now())
  userId          String?
  feedbackByUser  User?    @relation("UserToFeedbacks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ApiUsage {
  id               String   @id @default(cuid())
  userId           String?
  isGuest          Boolean  @default(true)
  endpoint         String
  model            String
  botId            String?
  inputTokens      Int      @default(0)
  outputTokens     Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCostUSD Decimal  @default(0.000000) @db.Decimal(10, 6)
  durationMs       Int?
  success          Boolean  @default(true)
  errorMessage     String?  @db.Text
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([endpoint])
}

model GuestUsage {
  id           String   @id @default(cuid())
  fingerprint  String   @unique
  messageCount Int      @default(0)
  weekStart    DateTime
  lastUsed     DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([fingerprint])
  @@index([weekStart])
}

model Purchase {
  id            String       @id @default(cuid())
  paypalOrderId String       @unique
  customerEmail String
  customerName  String?
  productId     String
  amount        Decimal      @db.Decimal(10, 2)
  currency      String       @default("EUR")
  upgradeCodeId String?
  upgradeCode   UpgradeCode? @relation(fields: [upgradeCodeId], references: [id])
  status        String       @default("COMPLETED")
  paypalPayload Json
  createdAt     DateTime     @default(now())

  @@index([customerEmail])
  @@index([paypalOrderId])
}

model NewsletterLog {
  id           String   @id @default(cuid())
  subjectDE    String
  subjectEN    String
  textBodyDE   String   @db.Text
  textBodyEN   String   @db.Text
  htmlBodyDE   String?  @db.Text
  htmlBodyEN   String?  @db.Text
  sentBy       String
  sentByEmail  String
  recipientCount Int
  successCount Int
  failedCount  Int
  errors       Json?
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([sentBy])
}

model AppConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([key])
}

model UserEvent {
  id        String   @id @default(cuid())
  eventType String   // e.g., 'GUEST_LOGIN', 'PAGE_VIEW', etc.
  userId    String?  // Optional, for logged-in users
  metadata  Json?    // Additional event data
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([createdAt])
  @@index([userId])
}

model PersonalityProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Metadata (unverschluesselt)
  testType        String   // "RIEMANN" oder "BIG5"
  filterWorry     Int      // 1-5 (grober Indikator)
  filterControl   Int      // 1-5 (grober Indikator)
  adaptationMode  String   @default("adaptive") // "adaptive" oder "stable"
  
  // VERSCHLUESSELT: Alle detaillierten Scores
  encryptedData   String   @db.Text
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  sessionCount    Int      @default(0)
  
  @@map("personality_profiles")
}

model SessionBehaviorLog {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId           String
  
  // Anonymisierte Frequenzen (unverschluesselt)
  dauerFrequency      Int @default(0)
  wechselFrequency    Int @default(0)
  naeheFrequency      Int @default(0)
  distanzFrequency    Int @default(0)
  
  // Comfort Check
  comfortScore        Int?
  optedOut            Boolean @default(false)
  
  // VERSCHLUESSELT: Vollstaendiges Transkript
  encryptedTranscript String @db.Text
  
  createdAt           DateTime @default(now())
  
  @@index([userId])
  @@index([sessionId])
  @@map("session_behavior_logs")
}
