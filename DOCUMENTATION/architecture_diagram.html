<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meaningful Conversations Architecture (v1.8.4)</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f8f9fa; color: #333; }
        h1 { margin-bottom: 4px; }
        .subtitle { color: #666; margin-bottom: 24px; font-size: 14px; }
        .diagram-container { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; overflow-x: auto; margin-bottom: 24px; }
        .diagram-container h2 { margin-top: 0; color: #555; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    </style>
</head>
<body>
    <h1>Meaningful Conversations - Architecture</h1>
    <p class="subtitle">Version 1.8.4 | February 2026</p>

    <div class="diagram-container">
        <h2>System Architecture</h2>
        <pre class="mermaid">
graph TB
    subgraph clients ["Clients"]
        Browser["Browser / PWA"]
        iOS["iOS App (Capacitor)"]
    end

    subgraph server ["Hetzner VPS (91.99.193.87)"]
        Nginx["Nginx Reverse Proxy + SSL"]

        subgraph stagingPod ["Staging Pod (mc-beta.manualmode.at)"]
            SFE["Frontend (Node.js)"]
            SBE["Backend (PM2 x2)"]
            STTS["TTS (Piper)"]
            SDB["MariaDB 11.2"]
        end

        subgraph productionPod ["Production Pod (mc-app.manualmode.at)"]
            PFE["Frontend (Node.js)"]
            PBE["Backend (PM2 x2)"]
            PTTS["TTS (Piper)"]
            PDB["MariaDB 11.2"]
        end
    end

    subgraph external ["External Services"]
        Gemini["Google Gemini API"]
        Mistral["Mistral AI (EU)"]
        Mailjet["Mailjet Email"]
    end

    Browser --> Nginx
    iOS --> Nginx
    Nginx --> SFE
    Nginx --> PFE
    SFE --> SBE
    SBE --> SDB
    SBE --> STTS
    SBE --> Gemini
    SBE --> Mistral
    SBE --> Mailjet
    PFE --> PBE
    PBE --> PDB
    PBE --> PTTS
    PBE --> Gemini
    PBE --> Mistral
    PBE --> Mailjet
        </pre>
    </div>

    <div class="diagram-container">
        <h2>Application Stack</h2>
        <pre class="mermaid">
flowchart LR
    subgraph clientLayer ["Client Layer"]
        direction TB
        ReactApp["React 18 + TypeScript"]
        WebCrypto["E2EE (AES-GCM)"]
        WebSpeech["Web Speech API"]
        TailwindCSS["Tailwind CSS"]
    end

    subgraph backendLayer ["Backend Layer"]
        direction TB
        Express["Express.js"]
        PM2["PM2 Cluster (x2)"]
        Prisma["Prisma ORM"]
        JWT["JWT Auth"]
        RateLimit["Rate Limiting"]
    end

    subgraph dataLayer ["Data Layer"]
        direction TB
        MariaDB["MariaDB 11.2"]
        PiperTTS["Piper TTS"]
    end

    subgraph aiLayer ["AI Layer"]
        direction TB
        GeminiSDK["Google GenAI SDK"]
        MistralSDK["Mistral AI SDK"]
        DPC["Dynamic Prompt Controller"]
        DPFL["Dynamic Profile Feedback Loop"]
    end

    clientLayer --> backendLayer
    backendLayer --> dataLayer
    backendLayer --> aiLayer
        </pre>
    </div>

    <div class="diagram-container">
        <h2>Deployment Pipeline</h2>
        <pre class="mermaid">
flowchart LR
    Code["Code Changes"] --> Build["Podman Build\n(npm ci)"]
    Build --> Push["Push to\nquay.myandi.de"]
    Push --> Pull["Pull on Server"]
    Pull --> SaveVer["Save Previous\nVersion"]
    SaveVer --> Stop["Stop Old\nContainers"]
    Stop --> Start["Start New\nContainers"]
    Start --> Health["Health Check\n(3 retries)"]
    Health -->|"Pass"| Done["Deploy OK"]
    Health -->|"Fail"| Rollback["Auto Rollback"]
    Rollback --> Restore["Restore Previous\nVersion"]
        </pre>
    </div>

    <div class="diagram-container">
        <h2>User Access Tiers</h2>
        <pre class="mermaid">
graph LR
    Guest["Guest\n(no account)"] --> Registered["Registered\n(free account)"]
    Registered --> Premium["Premium\n(isPremium)"]
    Premium --> Client["Client\n(isClient)"]
    Client --> Admin["Admin\n(isAdmin)"]
    Admin --> Developer["Developer\n(isDeveloper)"]
        </pre>
    </div>
</body>
</html>
